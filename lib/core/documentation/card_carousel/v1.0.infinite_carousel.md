# üé† Syst√®me de Carousels - Documentation Technique

## üìã Vue d'ensemble

Le syst√®me de carousels de l'application utilise une approche optimis√©e bas√©e sur `infinite_carousel` avec des **physics personnalis√©es** pour un comportement de d√©filement premium.

### üéØ Objectifs atteints
- ‚úÖ **Snap net sans rebond** - Fin d'animation rapide et pr√©cise
- ‚úÖ **Seuil de d√©clenchement 40px** - Changement de carte d√®s 40px de glissement
- ‚úÖ **Design responsive** - Adaptation automatique mobile/tablet
- ‚úÖ **Performance optimis√©e** - Lazy loading et cache intelligent
- ‚úÖ **Coh√©rence UI** - M√™me comportement sur tous les carousels

---

## üìÅ Fichiers cr√©√©s/modifi√©s

### üîß Core Components

#### `lib/core/theme/components/physics/threshold_40px_physics.dart`
**Physics personnalis√©e** - C≈ìur du syst√®me de d√©filement

```dart
// Features :
// - Ressort sur-critique (z√©ro rebond)
// - Seuil de d√©clenchement configurable (40px par d√©faut)
// - Logique directionnelle pr√©cise (√©vite le saut de 2 cartes)
Threshold40pxPhysics(
  landingFactor: 1.7,    // Vitesse de fin d'animation
  triggerPx: 40.0,       // Seuil de d√©clenchement
  itemExtent: cardWidth, // Largeur des cartes
)
```

#### `lib/core/theme/components/atoms/location_info.dart`
**Atom UI** - Ville avec ic√¥ne (respect Atomic Design)

```dart
LocationInfo(
  city: "P√©rigueux",
  iconSize: AppDimensions.iconSizeXs, // 12px pour cartes
)
```

#### `lib/core/theme/app_dimensions.dart`
**Syst√®me responsive** - Modifications apport√©es :

```dart
// Peeking optimis√© pour visibilit√©
static double calculateCarouselCardWidth(BoxConstraints constraints) {
  final peekWidth = 10.0; // Fixe pour preview suivante
  // ... calcul responsive
}

// Largeur minimale ajust√©e
static const double carouselMinCardWidth = 288.0; // +8px
```

### üé† Carousels

#### `lib/features/shared_ui/presentation/widgets/organisms/featured_activities_carousel.dart`
#### `lib/features/shared_ui/presentation/widgets/organisms/generic_activity_carousel.dart`

**Migration compl√®te** vers `InfiniteCarousel` avec :
- Physics `Threshold40pxPhysics`
- Syst√®me responsive int√©gr√©
- Skeletonizer pour loading states

---

## üèóÔ∏è Architecture technique

### 1. **Migration ListView ‚Üí InfiniteCarousel**

**Avant** (ListView + SnapCarouselPhysics custom) :
```dart
ListView.builder(
  physics: SnapCarouselPhysics(...), // 150+ lignes custom
  // ...
)
```

**Apr√®s** (InfiniteCarousel + package battle-tested) :
```dart
InfiniteCarousel.builder(
  physics: Threshold40pxPhysics(...), // 50 lignes focalis√©es
  velocityFactor: 0.8,                // Contr√¥le natif
  // ...
)
```

### 2. **Physics sur-critique (z√©ro rebond)**

**Principe math√©matique** :
```dart
// Ressort critique : damping = 2 √ó ‚àö(stiffness √ó mass)
// Sur-critique : damping = critical √ó 1.1 (aucune oscillation)
SpringDescription _criticallyDamped({required double stiffness}) {
  final critical = 2 * math.sqrt(stiffness * 1.0);
  return SpringDescription(
    mass: 1.0,
    stiffness: stiffness,
    damping: critical * 1.1, // ‚Üê Cl√© du "snap net"
  );
}
```

### 3. **Logique de seuil 40px**

**Calcul de position fractionnelle** (√©vite le bug "saut de 2 cartes") :
```dart
final cardPos = position.pixels / extent;      // Ex: 1.3 = carte 1, 30% vers carte 2
final offset = (cardPos - cardPos.floor()) * extent; // 30% √ó largeur = pixels

// Logique directionnelle pr√©cise
if (velocity > 0) {
  index = (offset > triggerPx) ? cardPos.floor() + 1 : cardPos.floor();
} else if (velocity < 0) {
  index = (offset < extent - triggerPx) ? cardPos.ceil() - 1 : cardPos.ceil();
}
```

### 4. **Syst√®me responsive unifi√©**

**Breakpoints carousels** :
```dart
// Mobile portrait : 1 carte
// Mobile paysage + tablet portrait : 2 cartes  
// Tablet paysage : 3 cartes
static int getCarouselCardCount(BoxConstraints constraints) {
  if (constraints.maxWidth < 600) return 1;
  if (constraints.maxWidth < 900) return 2;
  return 3;
}
```

---

## üöÄ Utilisation

### Carousel basique
```dart
GenericActivityCarousel(
  title: "Activit√©s populaires",
  activities: activities,
  openBuilder: (context, action, activity) => ActivityDetailPage(...),
)
```

### Carousel avec configuration custom
```dart
InfiniteCarousel.builder(
  physics: Threshold40pxPhysics(
    landingFactor: 2.0,    // Plus rapide
    triggerPx: 30.0,       // Plus sensible
    itemExtent: cardWidth,
  ),
  velocityFactor: 0.9,     // Inertie ajust√©e
  // ...
)
```

---

## ‚öôÔ∏è Configuration & Tuning

### Param√®tres de comportement

| Param√®tre | Valeur par d√©faut | Effet |
|-----------|------------------|-------|
| `landingFactor` | `1.7` | Vitesse fin d'animation (1.0 = normal, 2.0 = tr√®s rapide) |
| `triggerPx` | `40.0` | Seuil d√©clenchement en pixels |
| `velocityFactor` | `0.8` | Inertie g√©n√©rale (0.5 = lent, 1.0 = natif) |

### Debug & monitoring
```dart
// Debug temporaire dans _getTargetPixels
print('üîç offset: ${offset.toInt()}px, trigger: ${triggerPx}px, index: $index');
```

---

## üîÑ Migration d'anciens carousels

### 1. Remplacer ListView par InfiniteCarousel
```dart
// Supprimer
ListView.builder(...)

// Ajouter  
InfiniteCarousel.builder(
  physics: Threshold40pxPhysics(itemExtent: cardWidth),
  // ...
)
```

### 2. Ajouter imports
```dart
import 'package:infinite_carousel/infinite_carousel.dart';
import '../path/to/threshold_40px_physics.dart';
```

### 3. Adapter le padding
```dart
// Dans itemBuilder
padding: EdgeInsets.only(
  left: index == 0 ? AppDimensions.spacingS : 0,
  right: AppDimensions.spacingS,
)
```

---

## üß™ Tests & Validation

### Comportement attendu
- **Petit glissement < 40px** ‚Üí Snap vers position actuelle
- **Glissement 40-120px** ‚Üí Changement vers carte suivante/pr√©c√©dente
- **Fling fort** ‚Üí Saut de 2-3 cartes maximum
- **Fin d'animation** ‚Üí Arr√™t net sans oscillation

### Tests edge-cases
- ‚úÖ Premier/dernier item (pas de d√©passement)
- ‚úÖ Liste vide/1 item
- ‚úÖ Rotation √©cran (responsive)
- ‚úÖ Performance 60 FPS sur 100+ items

---

## üìö R√©f√©rences

- **Package** : [`infinite_carousel ^1.1.1`](https://pub.dev/packages/infinite_carousel)
- **Physics Flutter** : [ScrollPhysics documentation](https://api.flutter.dev/flutter/widgets/ScrollPhysics-class.html)
- **Spring theory** : Ressorts critiques et sur-amortis