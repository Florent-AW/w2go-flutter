## 📋 **Documentation - Système de Preload T0/T1 - Version corrigée**

### **🎯 Vue d'ensemble**

Le système de preload optimise l'expérience utilisateur lors du changement de ville en chargeant intelligemment les données en deux phases :

- **T0 (Critique ≤ 2.5s)** : Charge les données essentielles pour un affichage immédiat
- **T1 (Complétion ~1.5s)** : Complète automatiquement les données en arrière-plan

### **🔄 Flux utilisateur**

1. **User clique** sur CityPicker et sélectionne une ville
2. **Navigation** vers `/loading` avec paramètres (ville + type de page)
3. **LoadingRoute** démarre le PreloadController et précharge les images
4. **Navigation automatique** vers la page finale quand T0 terminé
5. **Complétion T1** : Les carrousels s'enrichissent automatiquement après 1.5s

### **⚙️ Logique T0/T1**

#### **Phase T0 - Chargement critique**
- **Carrousels 1-2** : 10 items chacun (événements + première catégorie)
- **Carrousels 3-7** : 5 items chacun (catégories suivantes)
- **Images** : Préchargement des thumbnails prioritaires
- **Navigation** : Dès que T0 terminé

#### **Phase T1 - Complétion automatique**
- **Timer 1.5s** : Déclenché automatiquement après affichage
- **Carrousels partiels** : Rechargés avec limite Supabase complète (≤30 items)
- **Update visuel** : Carrousels passent de 5 → 10+ items sans recharge de page

### **🔧 Architecture technique**

#### **Gestion des limites intelligente**
- **Preload** : Force les limites (5/10) via paramètre `p_limit`
- **Normal** : Utilise les limites de `merged_filter_config`
- **RPC Supabase** : Priorité au paramètre puis config base

#### **State Management**
- **PreloadController** : Orchestration et collecte des URLs d'images
- **PaginationController** : Nouveau système unifié remplaçant CityExperiencesController
- **GenericExperienceCarousel** : Utilise InfinitePagingCarousel avec T2 lazy loading

---

### **📁 Fichiers concernés**

#### **🎮 Contrôleurs principaux**

**`features/preload/application/preload_controller.dart`**
- Orchestration T0 : chargement différentiel (2×10 + 5×5 items)
- Collecte des URLs d'images critiques pour préchargement
- Expose `CarouselLoadInfo` avec flags `isPartial`

**`features/preload/application/preload_providers.dart`**
- Provider Riverpod pour injection du PreloadController

**`features/city_page/application/pagination/city_pagination_providers.dart`** ✅ **NOUVEAU**
- Remplace l'ancien CityExperiencesController
- PaginationController par carrousel avec autoDispose
- Cache granulaire par (ville + section + catégorie)

#### **🎨 Interface utilisateur**

**`features/preload/presentation/loading_route.dart`**
- Page de chargement avec spinner et texte dynamique
- Préchargement des images via `CachingImageProvider.precacheMultiple()`
- Navigation automatique quand preload terminé

**`features/shared_ui/widgets/molecules/city_picker.dart`**
- Déclenchement du preload au lieu de navigation directe
- Détection du type de page cible via `TargetPageService`

**`features/shared_ui/widgets/organisms/generic_experience_carousel.dart`**
- Conversion en StatefulWidget pour timer automatique
- Utilise maintenant `InfinitePagingCarousel` avec T2 lazy loading
- Plus de timer T1 interne - géré par ref.listen dans les wrappers

**`features/city_page/presentation/templates/city_page_template.dart`**
- Wrappers stateful `_CityPaginatedCarousel` par carrousel
- ref.listen pour détection T1 au lieu de callbacks
- Source de données unique via PaginationState

#### **🛠️ Services utilitaires**

**`features/preload/application/target_page_service.dart`**
- Détection du type de page cible (city/category) depuis la route

**`core/common/utils/caching_image_provider.dart`**
- Préchargement intelligent des images avec cache unifié
- Méthode `precacheMultiple()` avec contrôle de concurrence

**`core/theme/components/molecules/infinite_paging_carousel.dart`** ✅ **NOUVEAU**
- Widget avancé remplaçant InfiniteCarousel basique
- T2 lazy loading + pré-cache d'images + position initiale correcte

#### **🏗️ Infrastructure backend**

**`core/adapters/supabase/search/activity_search_adapter.dart`** ✅ **CORRIGÉ**
- ✅ **Fix critique** : Transmission du paramètre `p_offset` aux RPC
- Élimination complète des doublons T0→T1

**`core/adapters/supabase/search/event_search_adapter.dart`** ✅ **CORRIGÉ**
- ✅ **Fix critique** : Transmission du paramètre `p_offset` aux RPC
- Élimination complète des doublons T0→T1

**Fonctions RPC Supabase : `get_activities_list` & `get_events_list`** ✅ **CORRIGÉES**
- ✅ **Paramètre ajouté** : `p_offset integer DEFAULT 0`
- ✅ **OFFSET ajouté** : `OFFSET COALESCE(p_offset, 0);`
- Logique de limite : priorité `p_limit` puis `merged_filter_config`

#### **🔄 Navigation**

**`routes/app_router.dart`**
- Route `/loading` avec paramètres ville et type de page
- Passage des arguments au LoadingRoute

---

### **🧪 Points de validation**

#### **Performance T0**
- Chargement critique < 2.5s sur 4G
- Navigation immédiate possible après T0
- Préchargement de ~30-50 images thumbnails

#### **Expérience T1**
- Complétion automatique après 1.5s
- Transition fluide 5 → 10+ items par carrousel
- ✅ **Plus de doublons** grâce aux correctifs offset
- Pas de recharge complète de la page

#### **Expérience T2** ✅ **NOUVEAU**
- Lazy loading infini au scroll
- Pré-cache d'images 3 items à l'avance
- Position initiale correcte sur premier item

#### **Robustesse**
- Gestion des erreurs de preload (navigation quand même)
- Annulation propre si changement de ville rapide
- Fallback vers limites par défaut si config manquante
- ✅ **autoDispose** : Cleanup automatique des controllers

---

### **🚨 Correctifs critiques appliqués**

#### **Élimination des doublons T0→T1**
**Problème** : Les adapters ne transmettaient pas `p_offset` aux RPC Supabase.
**Solution** : Ajout de `'p_offset': filter.offset` dans activity_search_adapter.dart et event_search_adapter.dart.

#### **Position initiale carrousels**
**Problème** : Carrousels démarraient sur item 1 au lieu de item 0.
**Solution** : Calcul de position initiale alignée dans InfinitePagingCarousel.

#### **Migration vers architecture unifiée**
**Changement** : Remplacement CityExperiencesController par PaginationController + autoDispose.
**Avantage** : Code unifié, moins de duplication, performance améliorée.

---

### **🔮 Extensions prévues**

- **CategoryPage preload** : Même logique pour les pages catégories
- **Timeout management** : Fallback vers skeletons si délai dépassé
- **Cache optimisé** : Éviter rechargement si données déjà en cache
- **Monitoring** : Métriques de performance T0/T1/T2 en production
- **Adaptive loading** : Seuils T2 qui s'adaptent à la vitesse de scroll

---

**✅ Le système est opérationnel, sans bugs, et testable à chaque étape.**