# üìã **CategoryPage - Syst√®me Preload T0/T1 existant**

## üéØ **Vue d'ensemble**

CategoryPage utilise encore l'ancien syst√®me de preload (T0/T1) qui **fonctionne correctement**. Pas de migration vers le nouveau syst√®me de pagination unifi√© pour l'instant.

### **Architecture actuelle**
- **T0** : PreloadController charge donn√©es critiques via LoadingRoute
- **T1** : Timer automatique 1.5s dans GenericExperienceCarousel
- **Pas de T2** : Lazy loading pas impl√©ment√© sur CategoryPage

### **Structure carrousels**
- **Featured carousels** (x2) : Sections featured de la cat√©gorie s√©lectionn√©e
- **Subcategory carousels** (x3) : Premi√®re sous-cat√©gorie avec ses sections

---

## üèóÔ∏è **Architecture CategoryPage**

### **`features/categories/presentation/pages/category_page.dart`**
```dart
class CategoryPage extends ConsumerWidget {
  // Point d'entr√©e principal
  // G√®re selectedCategoryProvider et navigation
  // D√©l√®gue √† CategoryPageTemplate
}
```
**R√¥le** : Page wrapper qui g√®re la s√©lection de cat√©gorie et d√©l√®gue le rendu au template.

### **`features/categories/presentation/widgets/templates/category_page_template.dart`**
```dart
class CategoryPageTemplate extends ConsumerStatefulWidget {
  // Structure: AppBar + Cover + Featured + Subcategory tabs + Subcategory sections
  // Utilise coverController, tabControllers, scrollControllers
}
```
**R√¥le** : Template principal avec gestion d'√©tat complexe (onglets, scroll, cover, navigation).

---

## üé® **Organisms CategoryPage**

### **`features/categories/presentation/widgets/organisms/featured_section_organism.dart`**
```dart
class FeaturedSectionOrganism extends ConsumerStatefulWidget {
  // ‚úÖ CORRECTION STEP 2 : D√©tection preload + compl√©tion T1
  
  bool _isCarouselPartial(String categoryId, String sectionId) {
    final preloadData = ref.read(preloadControllerProvider);
    final carouselInfo = preloadData.carouselsInfo
        .where((info) => info.categoryId == categoryId && info.sectionId == sectionId)
        .firstOrNull;
    return carouselInfo?.isPartial ?? false;
  }
  
  void _completeCarousel(String categoryId, String sectionId) {
    ref.read(categoryExperiencesControllerProvider.notifier)
        .completeCarouselForCategory(categoryId, sectionId, selectedCity, isFeatured: true);
  }
}
```
**R√¥le** : G√®re carrousels Featured. Utilise encore preloadControllerProvider + categoryExperiencesController.

### **`features/categories/presentation/widgets/organisms/subcategory_activities_section.dart`**
```dart
class SubcategoryActivitiesSection extends ConsumerStatefulWidget {
  // ‚úÖ D√âJ√Ä FONCTIONNEL : D√©tection preload + compl√©tion T1
  
  bool _isCarouselPartial(String categoryId, String sectionId) {
    // M√™me logique que FeaturedSectionOrganism
  }
  
  void _completeCarousel(String categoryId, String sectionId) {
    ref.read(categoryExperiencesControllerProvider.notifier)
        .completeCarouselForCategory(categoryId, sectionId, selectedCity, isFeatured: false);
  }
}
```
**R√¥le** : G√®re carrousels Subcategory. Syst√®me T0/T1 fonctionnel depuis le d√©but.

---

## üîÑ **Flow CategoryPage T0/T1**

### **Navigation & Preload**
1. **LoadingRoute** d√©tecte `targetPageType = 'category'`
2. **PreloadController._preloadCategoryPage()** :
    - Featured carousel (10 items)
    - Premi√®re sous-cat√©gorie (3 carrousels √ó 5 items)
    - Collection URLs images
3. **Navigation** vers `/category` ‚Üí CategoryPageTemplate

### **Structure preload CategoryPage**
```dart
// PreloadController._preloadCategoryPage()
final carouselsInfo = <CarouselLoadInfo>[];

// Featured carousel (10 items) - pas partiel
await _loadCarouselWithLimit(city, firstCategory, 'featured-section-id', 10, ...);

// Premi√®re sous-cat√©gorie (3 √ó 5 items) - partiels  
for (section in subcategorySections.take(3)) {
  await _loadCarouselWithLimit(city, category, section.id, 5, ...);
}

// R√©sultat: carouselsInfo avec isPartial flags
```

### **D√©tection T1 dans organisms**
```dart
// Dans GenericExperienceCarousel
isPartial: _isCarouselPartial(categoryId, sectionId),
onRequestCompletion: () => _completeCarousel(categoryId, sectionId),

// Timer 1.5s dans initState/didUpdateWidget
if (widget.isPartial && widget.onRequestCompletion != null) {
  _scheduleCompletion(); // Timer automatique
}
```

---

## üéõÔ∏è **Controllers CategoryPage**

### **`features/city_page/application/providers/category_experiences_controller.dart`**
```dart
class CategoryExperiencesController extends Notifier<void> {
  Future<void> completeFeaturedCarousel(String categoryId, String sectionId, City city);
  Future<void> completeSubcategoryCarousel(String categoryId, String sectionId, City city);
  Future<void> completeCarouselForCategory(String categoryId, String sectionId, City city, {bool isFeatured = false});
}
```
**R√¥le** : Controller sp√©cialis√© CategoryPage pour compl√©tion T1. Invalide les providers concern√©s pour forcer rechargement.

### **`features/preload/application/preload_controller.dart`**
```dart
class PreloadController extends StateNotifier<PreloadData> {
  Future<void> _preloadCategoryPage(City city) async {
    // 1. Featured carousel (10 items)
    // 2. Premi√®re sous-cat√©gorie (3 carrousels √ó 5 items)
    // 3. Collection URLs images + CarouselLoadInfo
  }
}
```
**R√¥le** : Pr√©charge donn√©es CategoryPage. Collecte m√©tadonn√©es isPartial pour detection T1.

---

## üìä **Providers CategoryPage**

### **Providers Featured**
```dart
final featuredSectionsByCategoryProvider = FutureProvider.family<List<SectionMetadata>, String>;
final featuredActivitiesBySectionProvider = FutureProvider.family<List<ExperienceItem>, (...)>;
final featuredEventsBySectionProvider = FutureProvider.family<List<ExperienceItem>, (...)>;
```

### **Providers Subcategory**
```dart
final subcategoriesWithContentProvider = FutureProvider.family<List<Subcategory>, (...)>;
final effectiveSubcategorySectionsProvider = FutureProvider.family<List<SectionMetadata>, String>;
final subcategorySectionExperiencesProvider = FutureProvider.family<Map<String, List<ExperienceItem>>, (...)>;
```

**Particularit√©** : Providers classiques (pas family.autoDispose). Invalidation manuelle via CategoryExperiencesController.

---

## üîß **Points d'attention CategoryPage**

### **Ce qui fonctionne bien**
- ‚úÖ **T0 preload** : PreloadController._preloadCategoryPage() robuste
- ‚úÖ **T1 compl√©tion** : Timer GenericExperienceCarousel + CategoryExperiencesController
- ‚úÖ **Navigation** : LoadingRoute ‚Üí CategoryPage fluide
- ‚úÖ **Images** : Pr√©chargement 26+ images dans preload

### **Limitations actuelles**
- ‚ùå **Pas de T2** : Lazy loading scroll pas impl√©ment√©
- ‚ùå **Memory leaks potentiels** : Providers sans autoDispose
- ‚ùå **Cache invalidation** : Manuelle via controller, pas automatique

### **Logs CategoryPage typiques**
```dart
üîÑ PRELOAD CATEGORY: Pr√©chargement de Culture pour P√©rigueux
‚úÖ PRELOAD: 4 carrousels, 26 images
üîÑ TIMER T1: D√©tection false‚Üítrue pour Section Monuments  
üîÑ DEMANDE COMPL√âTION FEATURED pour cat√©gorie: culture-id, section: monuments-id
‚úÖ COMPLETION: Cat√©gorie Culture compl√©t√©e
```

---

## üîÆ **Migration future vers nouveau syst√®me**

### **√âtapes pour migration CategoryPage (quand prioritaire)**
1. **Cr√©er** `CategoryPaginationProviders` similaire √† `CityPaginationProviders`
2. **Migrer** `FeaturedSectionOrganism` vers wrapper stateful + ref.listen
3. **Migrer** `SubcategoryActivitiesSection` vers PaginationController
4. **Ajouter** T2 lazy loading dans GenericExperienceCarousel
5. **Nettoyer** CategoryExperiencesController + PreloadController CategoryPage

### **Avantages migration**
- **T2 lazy loading** : Scroll detection pour loads infinis
- **autoDispose** : Cleanup automatique m√©moire
- **Code unifi√©** : M√™me architecture que CityPage
- **Performance** : Cache granulaire + invalidation intelligente

**‚úÖ CategoryPage stable et fonctionnel en l'√©tat. Migration optionnelle pour homog√©n√©isation.**