# ğŸ“ Documentation Technique - SystÃ¨me de Distance UnifiÃ©

## Mise Ã  jour: v1.1.0 (1er Juin 2025)

## ğŸ¯ Vue d'ensemble

Le systÃ¨me de distance unifiÃ© fournit une **API centralisÃ©e** pour calculer et gÃ©rer les distances entre les activitÃ©s et la position de rÃ©fÃ©rence de l'utilisateur (ville sÃ©lectionnÃ©e ou GPS). Il garantit une **cohÃ©rence parfaite** dans toute l'application avec un cache intelligent et une auto-invalidation.

### âœ¨ FonctionnalitÃ©s ClÃ©s
- ğŸ¯ **API publique unique** pour toute l'application
- ğŸ“Š **Cache intelligent** avec auto-invalidation
- ğŸ™ï¸ **Position de rÃ©fÃ©rence** : ville sÃ©lectionnÃ©e â†’ GPS fallback
- âš¡ **Calcul batch optimisÃ©** pour les listes/carousels
- ğŸ”„ **Auto-invalidation** sur changement de ville
- ğŸ•’ **TTL cache** position GPS (15min)
- ğŸ“ **Facteur correction routiÃ¨re** (1.3x distance vol d'oiseau)

---

## ğŸ—ï¸ Architecture Finale

### ğŸ“Š Diagramme de Flux
```
User Interface
    â†“
activityDistancesProvider (API publique)
    â†“
ActivityDistancesNotifier (State management)
    â†“
ActivityDistanceManager (Service centralisÃ©)
    â†“
ActivityDistanceService (Calculs Haversine)
    â†“
Cache + Position de rÃ©fÃ©rence
```

### ğŸ­ Pattern Architectural
- **Clean Architecture** : Port/Adapter pattern respectÃ©
- **State Management** : Riverpod StateNotifier
- **Injection de dÃ©pendance** : Providers Riverpod
- **Cache hybride** : Manager + State local
- **Position intelligente** : Ville â†’ GPS fallback

---

## ğŸ“ Fichiers du SystÃ¨me

### ğŸ¯ **CÅ“ur du SystÃ¨me**

#### `lib/core/domain/ports/providers/location/activity_distance_manager_providers.dart`
**RÃ´le** : API publique et orchestrateur principal du systÃ¨me
- **`activityDistancesProvider`** : Provider principal (StateNotifier)
- **`ActivityDistancesNotifier`** : Gestion du state et cache local
- **`cityChangeListener`** : Auto-invalidation sur changement de ville
- **`distanceCacheStatsProvider`** : Statistiques debug

#### `lib/core/domain/services/location/activity_distance_manager.dart`
**RÃ´le** : Service centralisÃ© pour la gestion des distances
- Cache intelligent avec TTL
- Position de rÃ©fÃ©rence unifiÃ©e (ville â†’ GPS)
- Calcul batch optimisÃ©
- Invalidation sÃ©lective du cache

### âš™ï¸ **Services de Base**

#### `lib/core/domain/services/search/activity_distance_service.dart`
**RÃ´le** : Service de calcul des distances Haversine
- Calcul distance vol d'oiseau + facteur correction (1.3x)
- Cache basique Map<String, double>
- ImplÃ©mente `ActivityDistanceCalculationPort`

#### `lib/core/domain/ports/providers/search/distance_providers.dart`
**RÃ´le** : Provider pour le service de calcul de base
- Injecte `ActivityDistanceService`
- UtilisÃ© par `ActivityDistanceManager`

### ğŸ¨ **Composants UI**

#### `lib/core/theme/components/atoms/activity_distance_badge.dart`
**RÃ´le** : Badge de distance avec code couleur (< 5km vert, >= 5km gris)
- **Utilise** : `ref.watch(activityDistancesProvider)`
- **RÃ¨gle** : Ne jamais utiliser `ref.read` dans build()

### ğŸ  **Carousels d'ActivitÃ©s**

#### `lib/features/shared_ui/presentation/widgets/organisms/featured_activities_carousel.dart`
**RÃ´le** : Carousel des activitÃ©s recommandÃ©es
- **Utilise** : `ref.watch(activityDistancesProvider)`
- **MÃ©thode** : `_precacheDistancesIfNeeded` pour Ã©viter boucles infinies
- **Variable** : `allDistances` (naming cohÃ©rent)

#### `lib/features/shared_ui/presentation/widgets/organisms/generic_activity_carousel.dart`
**RÃ´le** : Carousel gÃ©nÃ©rique rÃ©utilisable
- **Utilise** : `ref.watch(activityDistancesProvider)`
- **MÃ©thode** : `_precacheDistancesIfNeeded` identique au featured
- **Variable** : `allDistances` (naming cohÃ©rent)

### ğŸ“„ **Pages et State Management**

#### `lib/features/activity_detail/application/state/activity_detail_notifier.dart`
**RÃ´le** : Notifier pour les dÃ©tails d'activitÃ©
- **MÃ©thode** : `_calculateAndCacheDistance` alimente le cache unifiÃ©
- **Utilise** : `ref.read(activityDistancesProvider.notifier)`

#### `lib/features/search/application/state/activity_providers.dart`
**RÃ´le** : Providers pour les activitÃ©s de recherche
- **Utilise** : `cacheActivitiesDistances` avec format record (id, lat, lon)
- **2 usages** : featuredActivities + subcategoryActivities

---

## ğŸ”Œ API Publique

### ğŸ“Š **Provider Principal**
```dart
// AccÃ¨s au cache des distances
final distances = ref.watch(activityDistancesProvider);
final distance = distances[activityId];

// Notifier pour actions
final notifier = ref.read(activityDistancesProvider.notifier);
```

### ğŸ¯ **MÃ©thodes ClÃ©s**

#### Calcul Batch (Carousels/Listes)
```dart
await notifier.cacheActivitiesDistances([
  (id: activity.id, lat: activity.latitude, lon: activity.longitude),
  // ... autres activitÃ©s
]);
```

#### Distance Individuelle
```dart
final distance = await notifier.getActivityDistance(
  activityId: id,
  activityLat: lat,
  activityLon: lon,
);
```

#### Gestion Cache
```dart
notifier.clearCache();                    // Vider tout le cache
notifier.invalidateOnReferenceChange();   // Invalider sur changement ville
```

---

## ğŸ§© **IntÃ©gration dans les Composants**

### âœ… **Pattern Correct (Widgets UI)**
```dart
class MyWidget extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    // âœ… TOUJOURS watch dans build()
    final distances = ref.watch(activityDistancesProvider);
    final distance = distances[activityId];
    
    return YourWidget(distance: distance);
  }
}
```

### âœ… **Pattern Correct (Carousels avec PrÃ©-cache)**
```dart
// Dans build()
WidgetsBinding.instance.addPostFrameCallback((_) {
  _precacheDistancesIfNeeded(activities, ref, distances);
});

// MÃ©thode helper
Future<void> _precacheDistancesIfNeeded(
  List<Activity> activities,
  WidgetRef ref,
  Map<String, double> currentDistances,
) async {
  final missing = activities.where((a) => 
    !currentDistances.containsKey(a.id)
  ).toList();
  
  if (missing.isEmpty) return; // âš¡ Guard clause importante
  
  final notifier = ref.read(activityDistancesProvider.notifier);
  await notifier.cacheActivitiesDistances(/* ... */);
}
```

### âŒ **Patterns Ã€ Ã‰viter**
```dart
// âŒ ref.read dans build() = pas de rÃ©activitÃ©
final distances = ref.read(activityDistancesProvider);

// âŒ Calcul sans guard = boucle infinie possible
await notifier.cacheActivitiesDistances(/* sans vÃ©rifier si dÃ©jÃ  en cache */);

// âŒ AccÃ¨s direct aux anciens services
final service = ref.read(activityDistanceServiceProvider); // Bypasse l'API unifiÃ©e
```

---

## ğŸš€ **Mise en Å’uvre (Nouveaux DÃ©veloppeurs)**

### 1ï¸âƒ£ **Ajouter Distance dans un Nouveau Widget**
```dart
class NewActivityWidget extends ConsumerWidget {
  final String activityId;
  
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final distances = ref.watch(activityDistancesProvider);
    final distance = distances[activityId];
    
    if (distance == null) {
      return Text('Distance non disponible');
    }
    
    return Text('${(distance / 1000).toStringAsFixed(1)} km');
  }
}
```

### 2ï¸âƒ£ **PrÃ©-calculer pour une Liste**
```dart
Future<void> _loadActivitiesWithDistances() async {
  final activities = await loadActivities();
  
  final notifier = ref.read(activityDistancesProvider.notifier);
  await notifier.cacheActivitiesDistances(
    activities.map((a) => (id: a.id, lat: a.lat, lon: a.lon)).toList()
  );
}
```

### 3ï¸âƒ£ **Ã‰couter les Changements de Ville**
Le systÃ¨me s'occupe automatiquement de l'invalidation via `cityChangeListener`.

---

## ğŸ”§ **Configuration et Constantes**

### ğŸ“Š **Constantes SystÃ¨mes**
```dart
// Dans ActivityDistanceManager
static const Duration _referencePositionTtl = Duration(minutes: 15);
static const double _roadDistanceFactor = 1.3;
```

### ğŸ¨ **Logique Badge Couleur**
```dart
// Dans ActivityDistanceBadge
Color _getDistanceColor(double distanceInMeters) {
  final distanceKm = distanceInMeters / 1000;
  return distanceKm < 5 ? Colors.green.shade600 : Colors.grey.shade600;
}
```

---

## ğŸ› **Troubleshooting**

### âŒ **"Distance non disponible"**
- VÃ©rifier que la ville est sÃ©lectionnÃ©e (`selectedCityProvider`)
- VÃ©rifier les permissions GPS si pas de ville
- Check logs : "Position de rÃ©fÃ©rence indisponible"

### âŒ **"Distances pas mises Ã  jour"**
- Utiliser `ref.watch` au lieu de `ref.read` dans build()
- VÃ©rifier que `cacheActivitiesDistances` est appelÃ©

### âŒ **"Performance dÃ©gradÃ©e"**
- VÃ©rifier que les guard clauses Ã©vitent les recalculs
- Utiliser `RepaintBoundary` sur les carousels
- Check cache stats via `distanceCacheStatsProvider`

### ğŸ” **Debug Commands**
```dart
// Statistiques cache
final stats = ref.read(distanceCacheStatsProvider);
print('Cache stats: $stats');

// Vider cache manuellement
ref.read(activityDistancesProvider.notifier).clearCache();
```

---

## ğŸ“ˆ **Ã‰volutions Futures**

### ğŸ¯ **Extensions Possibles**
- **Distance routiÃ¨re rÃ©elle** via Google Directions API
- **Cache persistant** avec Hive/SharedPreferences
- **Calcul parallÃ¨le** pour gros datasets
- **PrÃ©cision gÃ©olocalisation** variable selon contexte
- **Historique distances** pour analytics

### ğŸ—ï¸ **Points d'Extension**
- **`ActivityDistanceManager`** : ajouter nouveaux algorithmes
- **`ActivityDistanceCalculationPort`** : implÃ©menter nouveaux calculateurs
- **`ActivityDistancesNotifier`** : ajouter logiques mÃ©tier
- **Badge/UI** : personnaliser affichage selon contexte

---

## âœ… **Checklist Validation**

### ğŸ§ª **Tests Ã  Effectuer**
- [ ] Distance affichÃ©e correctement dans badges
- [ ] Cache fonctionne (pas de recalcul inutile)
- [ ] Changement ville invalide cache
- [ ] Fallback GPS quand pas de ville
- [ ] Performance carousels (pas de lag)
- [ ] Pas d'erreurs console

### ğŸ“‹ **Code Review Points**
- [ ] `ref.watch` dans tous les widgets UI
- [ ] Guard clauses dans prÃ©-cache methods
- [ ] Naming cohÃ©rent (`allDistances`)
- [ ] Pas d'accÃ¨s direct aux anciens services
- [ ] Imports corrects vers le systÃ¨me unifiÃ©

---

**ğŸ‰ Architecture 100% UnifiÃ©e et Production-Ready !**