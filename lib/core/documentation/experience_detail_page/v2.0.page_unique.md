# Documentation Technique: ExperienceDetailPage - Page unique v2.0

*Documentation v2.0 - Page Unifiée Activities + Events - 08/06/2025*

## 🎯 Vue d'ensemble

**ExperienceDetailPage** est LA page unique pour afficher les détails de toute expérience dans l'application. Fini ActivityDetailPage et EventDetailPage séparées - une seule page, une seule API, une maintenance simplifiée.

---

## 🏗️ Architecture de la page

### **Fichier principal**
```
lib/features/experience_detail/presentation/pages/experience_detail_page.dart
```

### **API unifiée**
```dart
class ExperienceDetailPage extends ConsumerStatefulWidget {
  final ExperienceItem experienceItem;  // ✅ Type unifié
  final VoidCallback onClose;

  const ExperienceDetailPage({
    Key? key,
    required this.experienceItem,     // ✅ Activities + Events
    required this.onClose,
  }) : super(key: key);
}
```

### **Utilisation dans toute l'app**
```dart
// ✅ Pour une Activity
final activityItem = ExperienceItem.activity(searchableActivity);
ExperienceDetailPage(
  experienceItem: activityItem,
  onClose: () => Navigator.pop(),
)

// ✅ Pour un Event  
final eventItem = ExperienceItem.event(searchableEvent);
ExperienceDetailPage(
  experienceItem: eventItem,
  onClose: () => Navigator.pop(),
)
```

---

## 🔄 Cycle de vie unifié

### **1. Initialisation**
```dart
@override
void initState() {
  super.initState();
  
  // ✅ Debug unifié Activities + Events
  print('🔍 EXPERIENCE DETAIL PAGE DEBUG:');
  print('  id: ${widget.experienceItem.id}');
  print('  name: ${widget.experienceItem.name}');
  print('  isEvent: ${widget.experienceItem.isEvent}');
  print('  categoryName: ${widget.experienceItem.categoryName}');

  // ✅ Chargement unifié
  WidgetsBinding.instance.addPostFrameCallback((_) {
    ref
        .read(experienceDetailProvider(widget.experienceItem).notifier)
        .loadExperienceDetails(widget.experienceItem);
  });
}
```

### **2. Gestion d'état unifiée**
```dart
@override
Widget build(BuildContext context) {
  final detailState = ref.watch(experienceDetailProvider(widget.experienceItem));

  return Scaffold(
    backgroundColor: Theme.of(context).scaffoldBackgroundColor,
    body: detailState.when(
      initial: () => _buildState([widget.experienceItem.mainImageUrl ?? '']),
      loading: () => _buildState([widget.experienceItem.mainImageUrl ?? '']),
      error: (message) => _buildErrorState(message),
      loaded: (details) => _buildState(details.imageUrls),
    ),
  );
}
```

### **3. Template unifié**
```dart
Widget _buildState(List<String> imageUrls) {
  return ExperienceDetailTemplate(
    experienceItem: widget.experienceItem,  // ✅ Passe ExperienceItem
    imageUrls: imageUrls,
    onDismiss: widget.onClose,
  );
}
```

---

## 🔌 Provider unifié

### **experienceDetailProvider**
```dart
final experienceDetailProvider = StateNotifierProvider.family<
  ExperienceDetailNotifier, 
  ExperienceDetailState, 
  ExperienceItem                    // ✅ Clé par ExperienceItem
>(
  (ref, experienceItem) {
    final useCase = ref.read(getExperienceDetailsUseCaseProvider);
    return ExperienceDetailNotifier(useCase, ref);
  },
);
```

### **Use Case unifié**
```dart
class GetExperienceDetailsUseCase {
  Future<ExperienceDetails> execute(ExperienceItem item) async {
    if (item.isEvent) {
      final eventDetails = await _eventUseCase.execute(item.id);
      return ExperienceDetails.event(eventDetails);
    } else {
      final activityDetails = await _activityUseCase.execute(item.id);
      return ExperienceDetails.activity(activityDetails);
    }
  }
}
```

---

## 📱 Navigation unifiée

### **Depuis les carousels**
```dart
// ✅ Navigation standard depuis featured cards
openBuilder: (context, action, activity) {
  final experienceItem = ExperienceItem.activity(activity);
  return ExperienceDetailPage(
    experienceItem: experienceItem,
    onClose: action,
  );
}

// ✅ Navigation depuis event cards
openBuilder: (context, action, event) {
  final experienceItem = ExperienceItem.event(event);
  return ExperienceDetailPage(
    experienceItem: experienceItem,
    onClose: action,
  );
}
```

### **Navigation programmatique**
```dart
// ✅ Helper dans AppRouter
static MaterialPageRoute createExperienceRoute(ExperienceItem item) {
  return MaterialPageRoute(
    builder: (_) => ExperienceDetailPage(
      experienceItem: item,
      onClose: () => Navigator.of(_).pop(),
    ),
    fullscreenDialog: true,
  );
}
```

### **NavigationUtils unifié**
```dart
class NavigationUtils {
  static void navigateToExperience(
    BuildContext context, {
    required ExperienceItem experienceItem,
  }) {
    Navigator.of(context).push(
      PageRouteBuilder(
        pageBuilder: (context, animation, secondaryAnimation) {
          return ExperienceDetailPage(
            experienceItem: experienceItem,
            onClose: () => Navigator.of(context).pop(),
          );
        },
        // ✅ Même transition pour Activities + Events
        transitionDuration: const Duration(milliseconds: 330),
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return FadeTransition(
            opacity: animation,
            child: ScaleTransition(
              scale: Tween<double>(begin: 0.8, end: 1.0).animate(
                CurvedAnimation(parent: animation, curve: Curves.easeOutCubic),
              ),
              child: child,
            ),
          );
        },
        fullscreenDialog: true,
      ),
    );
  }
}
```

---

## 🎨 Template switching intelligent

### **ExperienceDetailTemplate**
```dart
class ExperienceDetailTemplate extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final detailState = ref.watch(experienceDetailProvider(experienceItem));

    return Scaffold(
      body: Stack(
        children: [
          // ✅ Vue adaptée selon nombre d'images
          if (imageUrls.length <= 1)
            _buildTransitionView(context, detailState)
          else
            _buildCarouselView(context, detailState),

          // ✅ FloatingActionBar unifié
          Positioned(
            bottom: 0,
            left: 0,
            right: 0,
            child: ExperienceFloatingActionBar(experienceItem: experienceItem),
          ),
        ],
      ),
    );
  }
}
```

### **Transition view (1 image)**
```dart
Widget _buildTransitionView(BuildContext context, ExperienceDetailState detailState) {
  return CustomScrollView(
    slivers: [
      // ✅ Header avec image statique
      SliverPersistentHeader(
        delegate: _StaticImageHeaderDelegate(
          imageUrl: imageUrls.first,
          onDismiss: onDismiss,
        ),
      ),

      // ✅ Composants unifiés
      SliverToBoxAdapter(
        child: ExperienceIntroSection(experienceItem: experienceItem),
      ),
      
      SliverToBoxAdapter(
        child: ExperienceInfoSection(experienceItem: experienceItem),
      ),
      
      SliverToBoxAdapter(
        child: ExperienceDescriptionPanel(experienceItem: experienceItem),
      ),
    ],
  );
}
```

### **Carousel view (plusieurs images)**
```dart
Widget _buildCarouselView(BuildContext context, ExperienceDetailState detailState) {
  return CustomScrollView(
    slivers: [
      // ✅ Header avec carousel d'images
      SliverPersistentHeader(
        delegate: HeaderCarouselDelegate(
          imageUrls: imageUrls,
          onDismiss: onDismiss,
          experienceId: experienceItem.id,  // ✅ Générique
        ),
      ),

      // ✅ Mêmes composants unifiés
      SliverToBoxAdapter(
        child: ExperienceIntroSection(experienceItem: experienceItem),
      ),
      // ... autres sections
    ],
  );
}
```

---

## 🛡️ Gestion d'erreurs unifiée

### **Error State**
```dart
Widget _buildErrorState(String message) {
  return Center(
    child: Padding(
      padding: const EdgeInsets.all(24.0),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.error_outline, size: 64),
          const SizedBox(height: 24),
          Text('Impossible de charger les détails'),
          const SizedBox(height: 12),
          Text(message),
          const SizedBox(height: 32),
          Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              OutlinedButton(
                onPressed: widget.onClose, 
                child: const Text('Retour')
              ),
              const SizedBox(width: 16),
              ElevatedButton(
                onPressed: () => ref.invalidate(experienceDetailProvider(widget.experienceItem)),
                child: const Text('Réessayer'),
              ),
            ],
          ),
        ],
      ),
    ),
  );
}
```

---

## 🎯 Points clés de la migration

### **Avant (3 pages séparées)**
```dart
// ❌ ANCIEN : 3 pages différentes
ActivityDetailPage(activityId: id, title: title, ...)
EventDetailPage(eventId: id, title: title, ...)
ExperienceDetailPage(...) // Page test
```

### **Après (1 page unifiée)**
```dart
// ✅ NOUVEAU : 1 seule page pour tout
ExperienceDetailPage(
  experienceItem: ExperienceItem.activity(activity),
  onClose: onClose,
)

ExperienceDetailPage(
  experienceItem: ExperienceItem.event(event),
  onClose: onClose,
)
```

### **Avantages de la migration**
- ✅ **API cohérente** partout dans l'app
- ✅ **Maintenance simplifiée** : 1 seul endroit à maintenir
- ✅ **Type safety** : ExperienceItem garantit la cohérence
- ✅ **Navigation uniforme** : Même transition partout
- ✅ **Extensibilité** : Nouveau type = zéro changement

---

## 🧪 Tests & Validation

### **Test matrix**
```
✅ Activity avec 1 image → Transition view
✅ Activity avec carousel → Carousel view  
✅ Event avec 1 image → Transition view
✅ Event avec carousel → Carousel view
✅ Navigation depuis featured carousel
✅ Navigation depuis generic carousel
✅ Navigation depuis search results
✅ Navigation programmatique
✅ Error handling
✅ Loading states
```

### **Performance validée**
- ✅ **Provider cache** : Pas de duplication de state
- ✅ **Widget reuse** : Composants partagés optimisés
- ✅ **Memory usage** : Pas de leak avec family providers
- ✅ **Navigation speed** : Transition 330ms consistent

---

## 🔮 Extensions futures

### **Support multi-types**
```dart
// ✅ Architecture prête pour nouveaux types
const factory ExperienceItem.restaurant(SearchableRestaurant restaurant);
const factory ExperienceItem.accommodation(SearchableAccommodation accommodation);

// ExperienceDetailPage fonctionne automatiquement !
```

### **Fonctionnalités avancées**
- **Deep linking** : `/experience/{type}/{id}`
- **Share button** : URL uniforme pour tous types
- **Favorites** : Système unifié
- **Analytics** : Tracking cohérent

---

**ExperienceDetailPage = LA page unique pour toutes les expériences de l'app** 🚀

*Page unifiée conforme aux standards Clean Architecture + SOLID + Atomic Design selon Matej Resetar.*