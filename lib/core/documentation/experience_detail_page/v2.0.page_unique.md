# Documentation Technique: ExperienceDetailPage - Page unique v2.0

*Documentation v2.0 - Page UnifiÃ©e Activities + Events - 08/06/2025*

## ğŸ¯ Vue d'ensemble

**ExperienceDetailPage** est LA page unique pour afficher les dÃ©tails de toute expÃ©rience dans l'application. Fini ActivityDetailPage et EventDetailPage sÃ©parÃ©es - une seule page, une seule API, une maintenance simplifiÃ©e.

---

## ğŸ—ï¸ Architecture de la page

### **Fichier principal**
```
lib/features/experience_detail/presentation/pages/experience_detail_page.dart
```

### **API unifiÃ©e**
```dart
class ExperienceDetailPage extends ConsumerStatefulWidget {
  final ExperienceItem experienceItem;  // âœ… Type unifiÃ©
  final VoidCallback onClose;

  const ExperienceDetailPage({
    Key? key,
    required this.experienceItem,     // âœ… Activities + Events
    required this.onClose,
  }) : super(key: key);
}
```

### **Utilisation dans toute l'app**
```dart
// âœ… Pour une Activity
final activityItem = ExperienceItem.activity(searchableActivity);
ExperienceDetailPage(
  experienceItem: activityItem,
  onClose: () => Navigator.pop(),
)

// âœ… Pour un Event  
final eventItem = ExperienceItem.event(searchableEvent);
ExperienceDetailPage(
  experienceItem: eventItem,
  onClose: () => Navigator.pop(),
)
```

---

## ğŸ”„ Cycle de vie unifiÃ©

### **1. Initialisation**
```dart
@override
void initState() {
  super.initState();
  
  // âœ… Debug unifiÃ© Activities + Events
  print('ğŸ” EXPERIENCE DETAIL PAGE DEBUG:');
  print('  id: ${widget.experienceItem.id}');
  print('  name: ${widget.experienceItem.name}');
  print('  isEvent: ${widget.experienceItem.isEvent}');
  print('  categoryName: ${widget.experienceItem.categoryName}');

  // âœ… Chargement unifiÃ©
  WidgetsBinding.instance.addPostFrameCallback((_) {
    ref
        .read(experienceDetailProvider(widget.experienceItem).notifier)
        .loadExperienceDetails(widget.experienceItem);
  });
}
```

### **2. Gestion d'Ã©tat unifiÃ©e**
```dart
@override
Widget build(BuildContext context) {
  final detailState = ref.watch(experienceDetailProvider(widget.experienceItem));

  return Scaffold(
    backgroundColor: Theme.of(context).scaffoldBackgroundColor,
    body: detailState.when(
      initial: () => _buildState([widget.experienceItem.mainImageUrl ?? '']),
      loading: () => _buildState([widget.experienceItem.mainImageUrl ?? '']),
      error: (message) => _buildErrorState(message),
      loaded: (details) => _buildState(details.imageUrls),
    ),
  );
}
```

### **3. Template unifiÃ©**
```dart
Widget _buildState(List<String> imageUrls) {
  return ExperienceDetailTemplate(
    experienceItem: widget.experienceItem,  // âœ… Passe ExperienceItem
    imageUrls: imageUrls,
    onDismiss: widget.onClose,
  );
}
```

---

## ğŸ”Œ Provider unifiÃ©

### **experienceDetailProvider**
```dart
final experienceDetailProvider = StateNotifierProvider.family<
  ExperienceDetailNotifier, 
  ExperienceDetailState, 
  ExperienceItem                    // âœ… ClÃ© par ExperienceItem
>(
  (ref, experienceItem) {
    final useCase = ref.read(getExperienceDetailsUseCaseProvider);
    return ExperienceDetailNotifier(useCase, ref);
  },
);
```

### **Use Case unifiÃ©**
```dart
class GetExperienceDetailsUseCase {
  Future<ExperienceDetails> execute(ExperienceItem item) async {
    if (item.isEvent) {
      final eventDetails = await _eventUseCase.execute(item.id);
      return ExperienceDetails.event(eventDetails);
    } else {
      final activityDetails = await _activityUseCase.execute(item.id);
      return ExperienceDetails.activity(activityDetails);
    }
  }
}
```

---

## ğŸ“± Navigation unifiÃ©e

### **Depuis les carousels**
```dart
// âœ… Navigation standard depuis featured cards
openBuilder: (context, action, activity) {
  final experienceItem = ExperienceItem.activity(activity);
  return ExperienceDetailPage(
    experienceItem: experienceItem,
    onClose: action,
  );
}

// âœ… Navigation depuis event cards
openBuilder: (context, action, event) {
  final experienceItem = ExperienceItem.event(event);
  return ExperienceDetailPage(
    experienceItem: experienceItem,
    onClose: action,
  );
}
```

### **Navigation programmatique**
```dart
// âœ… Helper dans AppRouter
static MaterialPageRoute createExperienceRoute(ExperienceItem item) {
  return MaterialPageRoute(
    builder: (_) => ExperienceDetailPage(
      experienceItem: item,
      onClose: () => Navigator.of(_).pop(),
    ),
    fullscreenDialog: true,
  );
}
```

### **NavigationUtils unifiÃ©**
```dart
class NavigationUtils {
  static void navigateToExperience(
    BuildContext context, {
    required ExperienceItem experienceItem,
  }) {
    Navigator.of(context).push(
      PageRouteBuilder(
        pageBuilder: (context, animation, secondaryAnimation) {
          return ExperienceDetailPage(
            experienceItem: experienceItem,
            onClose: () => Navigator.of(context).pop(),
          );
        },
        // âœ… MÃªme transition pour Activities + Events
        transitionDuration: const Duration(milliseconds: 330),
        transitionsBuilder: (context, animation, secondaryAnimation, child) {
          return FadeTransition(
            opacity: animation,
            child: ScaleTransition(
              scale: Tween<double>(begin: 0.8, end: 1.0).animate(
                CurvedAnimation(parent: animation, curve: Curves.easeOutCubic),
              ),
              child: child,
            ),
          );
        },
        fullscreenDialog: true,
      ),
    );
  }
}
```

---

## ğŸ¨ Template switching intelligent

### **ExperienceDetailTemplate**
```dart
class ExperienceDetailTemplate extends ConsumerWidget {
  @override
  Widget build(BuildContext context, WidgetRef ref) {
    final detailState = ref.watch(experienceDetailProvider(experienceItem));

    return Scaffold(
      body: Stack(
        children: [
          // âœ… Vue adaptÃ©e selon nombre d'images
          if (imageUrls.length <= 1)
            _buildTransitionView(context, detailState)
          else
            _buildCarouselView(context, detailState),

          // âœ… FloatingActionBar unifiÃ©
          Positioned(
            bottom: 0,
            left: 0,
            right: 0,
            child: ExperienceFloatingActionBar(experienceItem: experienceItem),
          ),
        ],
      ),
    );
  }
}
```

### **Transition view (1 image)**
```dart
Widget _buildTransitionView(BuildContext context, ExperienceDetailState detailState) {
  return CustomScrollView(
    slivers: [
      // âœ… Header avec image statique
      SliverPersistentHeader(
        delegate: _StaticImageHeaderDelegate(
          imageUrl: imageUrls.first,
          onDismiss: onDismiss,
        ),
      ),

      // âœ… Composants unifiÃ©s
      SliverToBoxAdapter(
        child: ExperienceIntroSection(experienceItem: experienceItem),
      ),
      
      SliverToBoxAdapter(
        child: ExperienceInfoSection(experienceItem: experienceItem),
      ),
      
      SliverToBoxAdapter(
        child: ExperienceDescriptionPanel(experienceItem: experienceItem),
      ),
    ],
  );
}
```

### **Carousel view (plusieurs images)**
```dart
Widget _buildCarouselView(BuildContext context, ExperienceDetailState detailState) {
  return CustomScrollView(
    slivers: [
      // âœ… Header avec carousel d'images
      SliverPersistentHeader(
        delegate: HeaderCarouselDelegate(
          imageUrls: imageUrls,
          onDismiss: onDismiss,
          experienceId: experienceItem.id,  // âœ… GÃ©nÃ©rique
        ),
      ),

      // âœ… MÃªmes composants unifiÃ©s
      SliverToBoxAdapter(
        child: ExperienceIntroSection(experienceItem: experienceItem),
      ),
      // ... autres sections
    ],
  );
}
```

---

## ğŸ›¡ï¸ Gestion d'erreurs unifiÃ©e

### **Error State**
```dart
Widget _buildErrorState(String message) {
  return Center(
    child: Padding(
      padding: const EdgeInsets.all(24.0),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Icon(Icons.error_outline, size: 64),
          const SizedBox(height: 24),
          Text('Impossible de charger les dÃ©tails'),
          const SizedBox(height: 12),
          Text(message),
          const SizedBox(height: 32),
          Row(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              OutlinedButton(
                onPressed: widget.onClose, 
                child: const Text('Retour')
              ),
              const SizedBox(width: 16),
              ElevatedButton(
                onPressed: () => ref.invalidate(experienceDetailProvider(widget.experienceItem)),
                child: const Text('RÃ©essayer'),
              ),
            ],
          ),
        ],
      ),
    ),
  );
}
```

---

## ğŸ¯ Points clÃ©s de la migration

### **Avant (3 pages sÃ©parÃ©es)**
```dart
// âŒ ANCIEN : 3 pages diffÃ©rentes
ActivityDetailPage(activityId: id, title: title, ...)
EventDetailPage(eventId: id, title: title, ...)
ExperienceDetailPage(...) // Page test
```

### **AprÃ¨s (1 page unifiÃ©e)**
```dart
// âœ… NOUVEAU : 1 seule page pour tout
ExperienceDetailPage(
  experienceItem: ExperienceItem.activity(activity),
  onClose: onClose,
)

ExperienceDetailPage(
  experienceItem: ExperienceItem.event(event),
  onClose: onClose,
)
```

### **Avantages de la migration**
- âœ… **API cohÃ©rente** partout dans l'app
- âœ… **Maintenance simplifiÃ©e** : 1 seul endroit Ã  maintenir
- âœ… **Type safety** : ExperienceItem garantit la cohÃ©rence
- âœ… **Navigation uniforme** : MÃªme transition partout
- âœ… **ExtensibilitÃ©** : Nouveau type = zÃ©ro changement

---

## ğŸ§ª Tests & Validation

### **Test matrix**
```
âœ… Activity avec 1 image â†’ Transition view
âœ… Activity avec carousel â†’ Carousel view  
âœ… Event avec 1 image â†’ Transition view
âœ… Event avec carousel â†’ Carousel view
âœ… Navigation depuis featured carousel
âœ… Navigation depuis generic carousel
âœ… Navigation depuis search results
âœ… Navigation programmatique
âœ… Error handling
âœ… Loading states
```

### **Performance validÃ©e**
- âœ… **Provider cache** : Pas de duplication de state
- âœ… **Widget reuse** : Composants partagÃ©s optimisÃ©s
- âœ… **Memory usage** : Pas de leak avec family providers
- âœ… **Navigation speed** : Transition 330ms consistent

---

## ğŸ”® Extensions futures

### **Support multi-types**
```dart
// âœ… Architecture prÃªte pour nouveaux types
const factory ExperienceItem.restaurant(SearchableRestaurant restaurant);
const factory ExperienceItem.accommodation(SearchableAccommodation accommodation);

// ExperienceDetailPage fonctionne automatiquement !
```

### **FonctionnalitÃ©s avancÃ©es**
- **Deep linking** : `/experience/{type}/{id}`
- **Share button** : URL uniforme pour tous types
- **Favorites** : SystÃ¨me unifiÃ©
- **Analytics** : Tracking cohÃ©rent

---

**ExperienceDetailPage = LA page unique pour toutes les expÃ©riences de l'app** ğŸš€

*Page unifiÃ©e conforme aux standards Clean Architecture + SOLID + Atomic Design selon Matej Resetar.*